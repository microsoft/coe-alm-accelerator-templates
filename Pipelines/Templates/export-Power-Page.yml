#We are going to set websiteId as a pipeline variable only if there is a Power Page in the Dataverse

parameters:
- name: websiteId
  type: string
- name: repo
  type: string
- name: serviceConnectionUrl
  type: string
- name: serviceConnectionName
  type: string
- name: solutionName
  type: string
- name: websiteName
  type: string

steps:
- pwsh: |
    $websiteName = "NA"
    $solutionUnpackedFolder = "$(Build.SourcesDirectory)\${{parameters.repo}}\${{parameters.solutionName}}\PowerPages"
    Write-Host "solutionUnpackedFolder - $solutionUnpackedFolder"
    if(Test-Path "$solutionUnpackedFolder")
    {
        Write-Host "Power Pages Path Exists - $solutionUnpackedFolder"
        Get-ChildItem -Recurse "$solutionUnpackedFolder" -Depth 2 | Where { $_.PSIsContainer } | Select Name,FullName
        $matchedFolders = Get-ChildItem "$solutionUnpackedFolder" | Where-Object { $_.Name -match '${{parameters.websiteName}}'}
        Write-Host "matchedFolders - $matchedFolders"

        if($matchedFolders){
          $websiteName = $matchedFolders.Name
        }
    }
    else
    {
       Write-Host "Unpacked website folder unavailable. Path - $solutionUnpackedFolder"
    }
    Write-Host "websiteName - $websiteName"
    echo "##vso[task.setvariable variable=WebsiteName]$websiteName"
  displayName: "Fetch Portal Website Name"

#TODO Because the override flag is not exposed yet in tools, so we need to clear the folder manually
- pwsh: |
    $portalWebsitePath = "$(Build.SourcesDirectory)\${{parameters.repo}}\${{parameters.solutionName}}\PowerPages\$(WebsiteName)\"
    if(Test-Path "$portalWebsitePath"){
      Remove-Item "$portalWebsitePath\*" -Recurse -Force
    }
    else{
        Write-Host "Invalid path - $portalWebsitePath"
    }
  displayName: 'Clear Download Folder'
  condition: and(succeeded(), ne(variables['WebsiteName'], 'NA'))

- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.download-paportal.PowerPlatformDownloadPaportal@2
  displayName: 'Export Power Page ${{parameters.solutionName}} from ${{parameters.serviceConnectionUrl}}'
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: '${{parameters.serviceConnectionName}}'
    Environment: '${{parameters.serviceConnectionUrl}}'
    DownloadPath: '$(Build.SourcesDirectory)\${{parameters.repo}}\${{parameters.solutionName}}\PowerPages\'
    WebsiteId: ${{parameters.websiteId}}
  condition: and(succeeded(), ne(variables['websiteId'], 'NA'))